<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="aradmin.cmnt">

<!-- 영상별, 게시글별 댓글 목록 조회 -->
<select id="selectComtAllList" parameterType="ktv.aradmin.site.service.CommentVO" resultType="ktv.aradmin.site.service.CommentVO">
SELECT *
FROM(	
	SELECT ROWNUM PNUM
		 , LIST.*
	FROM (
		SELECT ROWNUM RNUM
	         , X.*
	   	FROM (
	        	  SELECT
		                CNTNTS_ID AS CONT_ID
		              , CMNT_NO
		              , CMNT  
		              , WRTER_ID
		              , WRTER_NM
		              , FRST_REGISTER_ID
		              , FRST_REGIST_PNTTM
		              , LAST_UPDUSR_ID
		              , LAST_UPDT_PNTTM
		              , USE_AT
		              , CMNT_TYPE
		              , (SELECT TITLE FROM AP_CNTNTS c WHERE c.CNTNTS_ID = a.CNTNTS_ID) AS TITLE
	              FROM AP_CNTNTS_COMMENT a
	              UNION
	              SELECT
		                NTT_ID AS CONT_ID
		              , CMNT_NO
		              , COMNT AS CMNT
		              , WRTER_ID
		              , WRTER_NM
		              , FRST_REGISTER_ID
		              , FRST_REGIST_PNTTM
		              , LAST_UPDUSR_ID
		              , LAST_UPDT_PNTTM
		              , USE_AT
		              , CMNT_TYPE
		              , (SELECT NTT_SJ FROM CO_BBS d WHERE d.NTT_ID = b.NTT_ID) AS TITLE
	              FROM CO_COMMENT b ) X
	     WHERE X.USE_AT = 'Y'
	     <if test="searchType == 'title'">
	     AND X.TITLE LIKE '%' || #{searchWrd} || '%'
	     </if>
	     <if test="searchType == 'cmnt'">
	     AND X.CMNT LIKE '%' || #{searchWrd} || '%'
	     </if>
	     <if test="searchType == 'writer'">
	     AND X.WRTER_NM LIKE '%' || #{searchWrd} || '%'
	     </if>
	     ORDER BY X.FRST_REGIST_PNTTM DESC
	     ) LIST
	     ) Y
	     <![CDATA[
	     WHERE Y.PNUM > #{firstIndex}
	     AND   Y.PNUM <= #{firstIndex} + #{recordCountPerPage}
	     ]]>
</select>

<!-- 해당 댓글 상세내용 -->
<select id="selectComtListDetail" parameterType="ktv.aradmin.site.service.CommentVO" resultType="ktv.aradmin.site.service.CommentVO">
	SELECT
		 X.CONT_ID
	   , X.CMNT_NO  
	   , X.TITLE
	   , X.CMNT
	   , X.CMNT_TYPE
	FROM (SELECT
	        CNTNTS_ID AS CONT_ID
	      , CMNT_NO
	      , CMNT  
		  , WRTER_ID
		  , WRTER_NM
		  , FRST_REGISTER_ID
		  , FRST_REGIST_PNTTM
		  , LAST_UPDUSR_ID
		  , LAST_UPDT_PNTTM
	      , USE_AT
	      , CMNT_TYPE
	      , (SELECT TITLE FROM AP_CNTNTS c WHERE c.CNTNTS_ID = a.CNTNTS_ID) AS TITLE
	      FROM AP_CNTNTS_COMMENT a
	      UNION
	      SELECT
	        NTT_ID AS CONT_ID
	      , CMNT_NO
	      , COMNT AS CMNT
		  , WRTER_ID
		  , WRTER_NM
		  , FRST_REGISTER_ID
		  , FRST_REGIST_PNTTM
		  , LAST_UPDUSR_ID
		  , LAST_UPDT_PNTTM
	      , USE_AT
	      , CMNT_TYPE
	      , (SELECT NTT_SJ FROM CO_BBS d WHERE d.NTT_ID = b.NTT_ID) AS TITLE
	      FROM CO_COMMENT b ) X
	      WHERE X.USE_AT = 'Y'
	      AND X.CONT_ID = #{contId}
	      AND X.CMNT_NO = #{cmntNo}
</select>


<update id="updateComtList" parameterType="ktv.aradmin.site.service.CommentVO">
	<!-- 영상별 댓글 수정 -->
	<if test = "cmntType == '0'">
		UPDATE
			AP_CNTNTS_COMMENT
		SET
			CMNT = #{cmnt}
		  , LAST_UPDUSR_ID = #{lastUpdusrId}
		  , LAST_UPDT_PNTTM = SYSDATE
		WHERE
			CMNT_TYPE = '0'
		AND CNTNTS_ID = #{contId}
		AND CMNT_NO = #{cmntNo}
	</if>
	<!-- 게시글별 댓글 수정 -->
	<if test = "cmntType == '1'">
		UPDATE
			CO_COMMENT
		SET
			COMNT = #{cmnt}
		  , LAST_UPDUSR_ID = #{lastUpdusrId}
		  , LAST_UPDT_PNTTM = SYSDATE
		WHERE
			CMNT_TYPE = '1'
		AND NTT_ID = #{contId}
		AND CMNT_NO = #{cmntNo}
	</if>
</update>


<update id="deleteComtList" parameterType="ktv.aradmin.site.service.CommentVO">
	<!-- 영상별 댓글 삭제 -->
	<if test = "cmntType == '0'">
	UPDATE
		AP_CNTNTS_COMMENT
	SET
		USE_AT = 'N'
	  , LAST_UPDUSR_ID = #{lastUpdusrId}
	  , LAST_UPDT_PNTTM = SYSDATE
	WHERE
		CMNT_TYPE = '0'
	AND CNTNTS_ID = #{contId}
	AND CMNT_NO = #{cmntNo}
	</if>
	<!-- 게시글별 댓글 삭제 -->
	<if test = "cmntType == '1'">
	UPDATE
		CO_COMMENT
	SET
		USE_AT = 'N'
	  , LAST_UPDUSR_ID = #{lastUpdusrId}
	  , LAST_UPDT_PNTTM = SYSDATE
	WHERE
		CMNT_TYPE = '1'
	AND NTT_ID = #{contId}
	AND CMNT_NO = #{cmntNo}
	</if>
</update>

<!-- 댓글목록 총 건수 조회 -->
<select id="selectComtAllListCnt" parameterType="HashMap" resultType="int">
	SELECT 
	      count(*)
	FROM (SELECT
	        CNTNTS_ID AS CONT_ID
	      , CMNT_NO
	      , CMNT  
		  , WRTER_ID
		  , WRTER_NM
		  , FRST_REGISTER_ID
		  , FRST_REGIST_PNTTM
		  , LAST_UPDUSR_ID
		  , LAST_UPDT_PNTTM
	      , USE_AT
	      , CMNT_TYPE
	      , (SELECT TITLE FROM AP_CNTNTS c WHERE c.CNTNTS_ID = a.CNTNTS_ID) AS TITLE
	      FROM AP_CNTNTS_COMMENT a
	      UNION
	      SELECT
	        NTT_ID AS CONT_ID
	      , CMNT_NO
	      , COMNT AS CMNT
		  , WRTER_ID
		  , WRTER_NM
		  , FRST_REGISTER_ID
		  , FRST_REGIST_PNTTM
		  , LAST_UPDUSR_ID
		  , LAST_UPDT_PNTTM
	      , USE_AT
	      , CMNT_TYPE
	      , (SELECT NTT_SJ FROM CO_BBS d WHERE d.NTT_ID = b.NTT_ID) AS TITLE
	      FROM CO_COMMENT b ) X
	      WHERE X.CONT_ID > 0
	      AND X.CMNT_NO > 0
	      AND X.USE_AT = 'Y'
</select>

</mapper>
